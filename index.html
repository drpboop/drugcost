<script>
  // format helper
  function fmt(n) { return (isFinite(n) ? n : 0).toFixed(2); }

  // core math (deductible first -> copay/coins -> OOP cap)
  function compute() {
    const errorBox = document.getElementById('errorBox');
    errorBox.textContent = '';

    // Numbers via valueAsNumber for consistency
    const retailRaw   = document.getElementById('retail').valueAsNumber ?? NaN;
    const retail      = Number.isFinite(retailRaw) ? retailRaw : 0;

    const shareVal    = document.getElementById('shareAmount').valueAsNumber ?? NaN;
    const shareUnit   = document.getElementById('shareUnit').value; // '$' or '%'

    const dedTotalRaw = document.getElementById('dedTotal').valueAsNumber ?? NaN;
    const dedPaidRaw  = document.getElementById('dedPaid').valueAsNumber  ?? NaN;
    const oopTotalRaw = document.getElementById('oopTotal').valueAsNumber ?? NaN;
    const oopPaidRaw  = document.getElementById('oopPaid').valueAsNumber  ?? NaN;

    const dedTotal = Number.isFinite(dedTotalRaw) ? dedTotalRaw : 0;
    const dedPaid  = Number.isFinite(dedPaidRaw)  ? dedPaidRaw  : 0;
    const oopTotal = Number.isFinite(oopTotalRaw) ? oopTotalRaw : 0;
    const oopPaid  = Number.isFinite(oopPaidRaw)  ? oopPaidRaw  : 0;

    // only render results once we have retail + amount + type
    const hasRetail = retail > 0;
    const hasShare  = Number.isFinite(shareVal) && shareVal >= 0 && (shareUnit === '$' || shareUnit === '%');

    const boxBenefit = document.getElementById('boxBenefit');
    const boxAcc  = document.getElementById('boxAcc');

    if (!(hasRetail && hasShare)) {
      boxBenefit.style.display = 'none';
      boxAcc.style.display  = 'none';
      return;
    }

    // basic sanity for totals
    if (dedTotal < 0 || oopTotal < 0) {
      errorBox.textContent = 'please enter valid plan totals for deductible and oop.';
      boxBenefit.style.display = 'none';
      boxAcc.style.display  = 'none';
      return;
    }

    // clamp paid vs totals
    const safeDedPaid = Math.min(Math.max(dedPaid, 0), Math.max(dedTotal, 0));
    const safeOopPaid = Math.min(Math.max(oopPaid, 0), Math.max(oopTotal, 0));

    const remainingDedBefore = Math.max(dedTotal - safeDedPaid, 0);
    const remainingOOPBefore = Math.max(oopTotal - safeOopPaid, 0);

    let dedApplied = 0;
    let costShare = 0;
    let preCap = 0;
    let memberCostFinal = 0;
    let capAdj = 0;
    let newDedPaid = safeDedPaid;
    let newOOP = safeOopPaid;

    if (safeOopPaid < oopTotal) {
      // deductible first
      dedApplied = Math.min(remainingDedBefore, retail);
      const retailAfterDed = retail - dedApplied;

      // cost-sharing on the post-deductible remainder
      if (retailAfterDed > 0) {
        if (shareUnit === '$') {
          costShare = shareVal; // copay
        } else {
          costShare = retailAfterDed * (shareVal / 100); // coinsurance
        }
      }

      preCap = dedApplied + costShare;

      // OOP cap
      const remainingOOPAvail = Math.max(oopTotal - safeOopPaid, 0);
      memberCostFinal = Math.min(preCap, remainingOOPAvail);
      capAdj = Math.max(preCap - memberCostFinal, 0);

      // update accumulators paid
      newDedPaid = safeDedPaid + dedApplied;
      newOOP     = safeOopPaid + memberCostFinal;
    }

    const remDedAfter = Math.max(dedTotal - newDedPaid, 0);
    const remOopAfter = Math.max(oopTotal - newOOP, 0);

    // show + update UI
    boxBenefit.style.display = '';
    boxAcc.style.display  = '';

    // mbr costs (renamed & reworded)
    document.getElementById('mbTotal').textContent      = `$${fmt(memberCostFinal)}`;
    document.getElementById('mbDedApplied').textContent = `$${fmt(dedApplied)}`;

    const shareLabelEl = document.getElementById('mbShareLabel');
    shareLabelEl.textContent = (shareUnit === '$') ? 'applied to copay' : 'applied to coinsurance';
    document.getElementById('mbShareApplied').textContent = `$${fmt(costShare)}`;

    const capGroup = document.getElementById('capGroup');
    if (capAdj > 0.00001) {
      capGroup.classList.remove('hide');
      document.getElementById('mbCapAdj').textContent = `-$${fmt(capAdj)}`;
    } else {
      capGroup.classList.add('hide');
    }

    // accumulators box
    document.getElementById('priorDed').textContent = `$${fmt(remainingDedBefore)}`;
    document.getElementById('priorOop').textContent = `$${fmt(remainingOOPBefore)}`;

    document.getElementById('afterDed').textContent = `$${fmt(newDedPaid)}`;
    document.getElementById('afterOop').textContent = `$${fmt(newOOP)}`;

    document.getElementById('remDed').textContent = remDedAfter > 0 ? `$${fmt(remDedAfter)}` : 'satisfied';
    document.getElementById('remOop').textContent = remOopAfter > 0 ? `$${fmt(remOopAfter)}` : 'satisfied';
  }

  // bind auto-calc to all inputs & type selector
  function bindAutoCalc() {
    const ids = [
      'retail',
      'shareAmount','shareUnit',
      'dedTotal','dedPaid','oopTotal','oopPaid'
    ];
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('input', compute);
      el.addEventListener('change', compute);
      el.addEventListener('blur', compute); // <- key addition for Tab reliability
    });
  }

  // init
  document.addEventListener('DOMContentLoaded', () => {
    bindAutoCalc();
    compute(); // run once for autofilled values (if any)
  });

  // (Optional) compute on Enter anywhere
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') compute();
  });
</script>
